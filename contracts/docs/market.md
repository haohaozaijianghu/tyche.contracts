# Tyche Market 需求概览

> 说明：原先拆分的 Earn 与 Loan 产品形态不再需要，统一为 Market（Aave 式抵押借贷市场）。

## 产品形态
- 链上抵押借贷市场（Aave-like Money Market）。
- 用户可以存入资产赚取利息，也可以用资产作抵押借出其他资产。
- 系统按利用率自动调节利率，并在风险失控时自动清算。

## 核心参与者
- **存款人（Supplier）**：提供流动性并赚取利息。
- **借款人（Borrower）**：抵押资产并借出资产。
- **清算人（Liquidator）**：为系统清理坏账并赚取清算奖励。
- **协议（Tyche）**：管理资金池、利率与风险。

## 核心业务实体
### Reserve（资产池）
- 每一种可借贷资产对应一个独立的 Reserve。
- 关键要素：底层资产（token 合约与符号）、风控规则、利率模型、实时资金状态。
- 业务示例：ETH 池、USDT 池、BTC 池各自独立运行。

### User Position（用户仓位）
- 每个用户在单个 Reserve 上可以进行两类操作：存（Supply）与借（Borrow）。
- 存入的资产可选择开启或关闭抵押属性（Collateral）。

### 协议状态（全局）
- 池子侧：总存款、总借款、利息指数。
- 用户侧：抵押价值、借款价值、健康因子（HF）。

## 生命周期（从 0 到清算）
### 1. 创建资产池（Reserve Setup）
管理员上线一个可借贷资产，需要配置：
- **max_ltv**：抵押后最大可借比例。
- **liquidation_threshold**：触发风险警戒阈值。
- **liquidation_bonus**：清算人奖励比例。
- **reserve_factor**：协议抽成。
- **U_opt**：最优利用率。
- **r0 / r_opt / r_max**：借款利率曲线参数。

业务规则：
- Reserve 上线后用户才能存/借，可随时暂停（Pause）。

### 2. 存款（Deposit / Supply）
用户将代币转入 Tyche，系统依次执行：
1. 更新利息（推进指数）。
2. 换算存款份额（Supply Shares）。
3. 增加池子总存款。
4. 记录用户份额。
5. 默认开启抵押属性。

要点：存款本身不等于抵押，只是可用于抵押的资产。

### 3. 开关抵押（Enable / Disable Collateral）
- 用户可以关闭抵押：该资产不再计入 HF，但继续赚利息。
- 风险规则：关闭操作不得导致 HF < 1，否则直接拒绝。

### 4. 借款（Borrow）
用户借出另一种资产时，系统必须：
1. 更新相关 Reserve 的利息（借出池与抵押池）。
2. 计算借款后的 HF。
   - 公式：HF = 抵押价值 × 清算阈值 / 借款价值。
3. 校验 HF ≥ 1、不超过 max_ltv、池子流动性充足。
4. 生成 Borrow Shares 并增加 total_borrowed。
5. 将资产打给用户。

原则：借款后仍需保持安全。

### 5. 利息模型
- 不定时结算，不遍历用户，依靠利息指数。
- 利用率 U = 总借款 / 总存款。
- 借款利率分段：
  - U ≤ U_opt：线性增长。
  - U > U_opt：陡峭增长（惩罚）。
- 存款利率 = 借款利率 × 利用率 × (1 - reserve_factor)。

效果：借得越多，借款越贵；借得越多，存款越赚钱。

### 6. 还款（Repay）
- 系统流程：更新利息 → 计算当前真实债务 → 扣减 Borrow Shares → 退回多还部分 → 更新池子状态。
- 支持代还与部分还款。

### 7. 提现（Withdraw）
- 校验流程：更新利息 → 扣减 Supply Shares → 确认提现后 HF ≥ 1 → 检查池子流动性。
- 提现后仍需保持整体仓位安全。

### 8. 清算（Liquidation）
- 触发：HF < 1。
- 清算人用资产替用户还债，获得其抵押资产和奖励。
- 系统步骤：校验可清算 → 限制最大清算比例（如 50%）→ 计算偿还与可领取抵押 → 更新双方仓位 → 资产转账。

目标：防止系统坏账并确保清算激励。