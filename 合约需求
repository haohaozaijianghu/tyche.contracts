一、Tyche 是什么（先定清“产品形态”）

Tyche = 链上抵押借贷市场（Aave-like Money Market）

一句话：
	•	用户 存资产赚利息
	•	用户 用资产作抵押借出其他资产
	•	系统 按利用率自动调节利率
	•	系统 在风险失控时自动清算

⸻

二、核心参与者（业务视角）

角色	作用
存款人（Supplier）	提供流动性，赚利息
借款人（Borrower）	抵押资产，借出资产
清算人（Liquidator）	帮系统清理坏账，赚清算奖励
协议（Tyche）	管理资金池、利率、风险


⸻

三、核心对象（不是表，是“业务实体”）

1️⃣ Reserve（资产池）

每一种可借贷资产 = 一个 Reserve

Reserve 具备：
	•	一种底层资产（token_contract + symbol）
	•	一套风控规则
	•	一套利率模型
	•	一份实时资金状态

📌 业务理解

“ETH 池”、“USDT 池”、“BTC 池”各自独立运行

⸻

2️⃣ User Position（用户仓位）

用户在每个 Reserve 上可能有 2 种行为：

	•	存（Supply）
	•	借（Borrow）

并且：
	•	存的资产 可作为抵押（Collateral，可开关）

⸻

3️⃣ 协议状态（全局）
	•	各池子的：
	•	总存款
	•	总借款
	•	利息指数
	•	用户的：
	•	抵押价值
	•	借款价值
	•	健康因子 HF

⸻

四、完整业务生命周期（从 0 到 清算）

⸻

① 创建资产池（Reserve Setup）

功能

管理员上线一个可借贷资产

必要参数（业务含义）

参数	业务意义
max_ltv	抵押后最多能借多少
liquidation_threshold	到多少就危险
liquidation_bonus	清算人奖励
reserve_factor	协议抽成
U_opt	最优利用率
r0 / r_opt / r_max	借款利率曲线

📌 关键业务规则
	•	一个 Reserve 一旦上线，用户才能存/借
	•	可以被 Pause

⸻

② 存款（Deposit / Supply）

用户行为

把 token 转给 Tyche

系统要做的事（严格顺序）
	1.	更新利息
	•	把上次到现在的利息算出来（指数前推）
	2.	换算存款份额（Supply Shares）
	•	不是直接记金额
	3.	增加池子总存款
	4.	给用户记账
	5.	默认开启抵押属性

📌 重要原则
	•	存款本身 ≠ 抵押
	•	只是「可作为抵押的资产」

⸻

③ 开关抵押（Enable / Disable Collateral）

用户行为

“我存了，但不想用它做抵押”

业务规则
	•	关闭抵押后：
	•	该资产 不计入 HF
	•	但：
	•	仍然 继续赚利息

📌 风险规则
	•	关闭抵押 不能导致 HF < 1
	•	否则直接拒绝

⸻

④ 借款（Borrow）

用户行为

借出另一种资产

系统必须检查的事（非常重要）

1️⃣ 更新所有相关 Reserve 的利息
	•	借的池
	•	抵押的池

2️⃣ 计算借款后的健康因子 HF

HF = 抵押资产价值 × 清算阈值
     ─────────────────────
           借款价值

3️⃣ 校验
	•	HF ≥ 1
	•	不超过 max_ltv
	•	池子有足够流动性

4️⃣ 记账
	•	生成 Borrow Shares
	•	增加 total_borrowed

5️⃣ 打币给用户
📌 核心思想

借款永远是：
“借后仍然安全”

⸻

⑤ 利息如何产生（最核心）

关键点
	•	不定时结算
	•	不遍历用户
	•	靠指数

借款利率

利用率 U = 总借款 / 总存款

分段：
	•	U ≤ Uopt：线性增长
	•	U > Uopt：陡峭增长（惩罚）

存款利率

存款利率 =
借款利率 × 利用率 × (1 - reserve_factor)

📌 业务效果
	•	借得越多 → 借款越贵
	•	借得越多 → 存款越赚

⸻

⑥ 还款（Repay）

用户行为

归还部分或全部借款

系统行为
	1.	更新利息
	2.	计算当前真实债务
	3.	扣减 Borrow Shares
	4.	多还的部分退回
	5.	更新池子状态

📌 允许
	•	帮别人还
	•	只还一部分

⸻

⑦ 提现（Withdraw）

用户行为

把之前存的资产取走

系统必须校验
	1.	更新利息
	2.	扣减 Supply Shares
	3.	提现后 HF ≥ 1
	4.	池子流动性足够

📌 关键

提现 ≠ 自由
提现后仍要安全

⸻

⑧ 清算（Liquidation）

触发条件

HF < 1

清算人行为
	•	用某资产 帮用户还债
	•	换取其抵押资产 + bonus

系统流程
	1.	校验用户可清算
	2.	限制最大清算比例（如 50%）
	3.	计算：
	•	偿还债务
	•	可拿抵押
	4.	更新双方仓位
	5.	转账资产

📌 业务目标
	•	系统永不坏账
	•	清算人有动力
